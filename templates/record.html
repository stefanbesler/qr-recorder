<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Recorder</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}

body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    background:#f5f5f5;
    display:flex;
    align-items:center;
    justify-content:center;
}

.card{
    background:white;
    padding:1.2em;
    border-radius:20px;
    box-shadow:0 4px 20px rgba(0,0,0,0.08);
    width:90%;
    max-width:400px;
    text-align:center;
}

h1{
    font-size:2em;
    margin-bottom:0.5em;
    font-weight:700;
    background:linear-gradient(45deg,#2196F3,#1976D2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.record-btn{
    width:100px;
    height:100px;
    border-radius:50%;
    border:none;
    background:#f0f0f0;
    margin:1em auto;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:36px;
    cursor:pointer;
    transition:0.3s;
}

.record-btn.idle i{color:#666;}

.record-btn.recording{
    background:#ffebee;
    box-shadow:0 0 25px rgba(244,67,54,0.4);
    animation:pulse 1.2s infinite;
}

.record-btn.recording i{color:#f44336;}

.record-btn.uploading{
    background:#fff3e0;
}
.record-btn.uploading i{color:#ff9800;}

@keyframes pulse{
    0%{transform:scale(1);}
    50%{transform:scale(1.08);}
    100%{transform:scale(1);}
}

.message{
    margin-top:1em;
    padding:0.8em;
    border-radius:12px;
    background:#e3f2fd;
    color:#1976d2;
    display:none;
}
.message.show{display:block;}

.qr{
    margin-top:1em;
}
.qr img{
    width:180px;
    border-radius:12px;
}
#indexBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: #1976D2;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    text-decoration: none;
    transition: 0.3s;
}
#indexBtn:hover {
    background: #115293;
    transform: scale(1.05);
}
</style>
</head>

<body>
<div class="card">

<h1>Recorder</h1>

<button id="recordBtn" class="record-btn idle">
    <i class="fas fa-microphone"></i>
</button>

<div id="timer" style="margin-top:0.5em;font-weight:600;font-size:1.1em;">
00:00
</div>

<div id="message" class="message"></div>

<div class="qr" id="qr"></div>

</div>

<a href="/" id="indexBtn" title="All Recordings">
    <i class="fas fa-list"></i>
</a>

<script>
let timerInterval = null;
let startTime = null;
const timerEl = document.getElementById("timer");
let mediaRecorder;
let chunks = [];
let isRecording = false;
let currentStream = null;

const btn = document.getElementById("recordBtn");
const msg = document.getElementById("message");
const qrDiv = document.getElementById("qr");

function startTimer(){
    startTime = Date.now();

    timerInterval = setInterval(()=>{
        const diff = Date.now() - startTime;
        const sec = Math.floor(diff/1000);
        const m = String(Math.floor(sec/60)).padStart(2,'0');
        const s = String(sec%60).padStart(2,'0');
        timerEl.textContent = `${m}:${s}`;
    },200);
}

function stopTimer(){
    clearInterval(timerInterval);
}

function setState(state){
    btn.className = "record-btn " + state;
}

function printQR(){
    const qr = document.getElementById("qrImage").src;

    const w = window.open("","","width=300,height=300");

    w.document.write(`
    <html>
    <head>
    <style>
    @page { margin:0; }
    body{
        display:flex;
        align-items:center;
        justify-content:center;
        height:100vh;
    }
    img{
        width:2cm;
        height:2cm;
    }
    </style>
    </head>
    <body>
        <img src="${qr}">
        <script>
            window.onload = () => {
                window.print();
                setTimeout(()=>window.close(),500);
            };
        <\/script>
    </body>
    </html>
    `);

    w.document.close();
}


btn.onclick = async () => {

    if(!isRecording){

        qrDiv.innerHTML = "";
        msg.classList.remove("show");

        currentStream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(currentStream, {
            mimeType: 'audio/webm;codecs=opus',
            audioBitsPerSecond: 48000
        });
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = uploadAudio;

        mediaRecorder.start();
        startTimer();
        isRecording = true;

        setState("recording");
        msg.textContent = "Recording… tap again to stop";
        msg.classList.add("show");

    }else{

        stopTimer();
        mediaRecorder.stop();
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
        
        isRecording = false;

        setState("uploading");
        msg.textContent = "Uploading…";
    }
};

async function uploadAudio(){

    const blob = new Blob(chunks,{type:"audio/webm"});
    const form = new FormData();
    form.append("audio", blob, "recording.webm");

    const res = await fetch("/upload",{method:"POST",body:form});
    const data = await res.json();

    setState("idle");

    msg.textContent = "Ready to play";
    
    qrDiv.innerHTML = `
        <div class="qr-print">
            <img id="qrImage" src="${data.qr_url}" style="
                width:180px;
                border-radius:12px;
                box-shadow:0 2px 12px rgba(0,0,0,0.08);
            ">
        </div>

        <button onclick="printQR()" style="
            margin-top:12px;
            padding:10px 14px;
            border:none;
            border-radius:12px;
            background:#1976D2;
            color:white;
            font-weight:600;
            cursor:pointer;
            width:100%;
            transition:0.2s;
        ">
            <i class="fas fa-print" style="margin-right:6px;"></i>
            Print QR
        </button>

        <a href="${data.play_url}" target="_blank" style="
            margin-top:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            text-decoration:none;
            padding:12px;
            border-radius:12px;
            background:#e3f2fd;
            color:#1976D2;
            font-weight:600;
            width:100%;
            transition:0.2s;
        ">
            <i class="fas fa-play"></i>
            Open Player
        </a>
        `;
}
</script>


</body>
</html>
